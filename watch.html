<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encelada - –ü—Ä–æ—Å–º–æ—Ç—Ä</title>
    <link rel="icon" type="image/webp" href="images/logo.webp">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/custom.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .player-aspect {
            aspect-ratio: 16 / 9;
        }

        .player-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .player-modal-content {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid #333;
        }

        .player-list-item {
            width: 100%;
            text-align: left;
            padding: 12px 16px;
            background: #2a2a2a;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .player-list-item:hover {
            background: #3a3a3a;
            transform: translateY(-1px);
        }

        .player-list-item.active {
            background: #dc2626;
            box-shadow: 0 0 12px rgba(220, 38, 38, 0.4);
        }

        .control-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: #2a2a2a;
            color: #fff;
            border-color: #555;
        }

        .control-btn.active {
            color: #dc2626;
            border-color: #dc2626;
        }

        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a1a;
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            margin-bottom: 8px;
            border: 1px solid #333;
        }

        .control-btn:hover .tooltip {
            opacity: 1;
        }
    </style>
</head>

<body class="bg-black text-white min-h-screen">
    <div id="app"></div>

    <script type="module">
        import { renderHeader, renderFooter, renderRatingBar, renderCommentsSection } from './js/components.js';
        import { getMovieDetails, getTVSeriesDetails, addToHistory } from './js/api.js';
        import { initMobileMenu, updateAuthLinks, initSearch } from './js/utils.js';
        import { initCommentsLogic } from './js/comments.js';

        const app = document.getElementById('app');
        let players = [];
        let selectedPlayerIndex = 0;
        let theaterMode = false;

        async function initWatchPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            const type = urlParams.get('type') || 'movie';

            if (!id) {
                window.location.href = 'index.html';
                return;
            }

            app.innerHTML = renderHeader();
            initMobileMenu();
            updateAuthLinks();
            initSearch();

            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const item = type === 'movie' ? await getMovieDetails(id) : await getTVSeriesDetails(id);
                const title = item.title || item.name;

                // For dynamic background
                window.currentBackdrop = item.backdrop_path ? `https://image.tmdb.org/t/p/original${item.backdrop_path}` : null;
                const { applyGlobalSettings } = await import('./js/utils.js');
                applyGlobalSettings();

                let lastProgressSync = 0;
                let currentProgress = {
                    time: 0,
                    duration: 0,
                    season: urlParams.get('s') || null,
                    episode: urlParams.get('e') || null
                };

                function loadPlayer(index) {
                    selectedPlayerIndex = index;
                    const player = players[index];

                    // Construct iframe URL with season/episode if it's a TV show
                    let iframeUrl = player.iframeUrl;
                    if (type === 'tv' && currentProgress.season && currentProgress.episode) {
                        // Some players use s/e in URL, others in postMessage. 
                        // For Reyohoho/Alloha we often append or they handle it differently.
                        // For generic ones like vidsrc:
                        if (iframeUrl.includes('vidsrc')) {
                            iframeUrl += (iframeUrl.includes('?') ? '&' : '?') + `s=${currentProgress.season}&e=${currentProgress.episode}`;
                        }
                    }

                    playerContainer.innerHTML = `<iframe id="player-iframe" src="${iframeUrl}" class="absolute inset-0 w-full h-full" allowfullscreen referrerpolicy="no-referrer"></iframe>`;

                    // Update header name
                    currentPlayerName.textContent = player.type;

                    localStorage.setItem('preferred_player', player.type);
                }

                // Add to history (automatically when page opens)
                if (localStorage.getItem('token')) {
                    await addToHistory(item, type).catch(err => console.error('History error:', err));
                }

                const main = document.createElement('main');
                main.className = 'pt-24 pb-12 max-w-6xl mx-auto px-4';
                main.innerHTML = `
                    <div class="mb-4 flex flex-col md:flex-row md:items-end justify-between gap-4">
                        <div>
                            <nav class="flex text-gray-500 text-sm mb-2" aria-label="Breadcrumb">
                                <ol class="list-none p-0 inline-flex">
                                    <li class="flex items-center">
                                        <a href="index.html" class="hover:text-red-600 transition">–ì–ª–∞–≤–Ω–∞—è</a>
                                        <svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
                                    </li>
                                    <li class="flex items-center">
                                        <a href="details.html?id=${id}&type=${type}" class="hover:text-red-600 transition">${title}</a>
                                        <svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
                                    </li>
                                    <li class="text-white font-bold">–ü—Ä–æ—Å–º–æ—Ç—Ä</li>
                                </ol>
                            </nav>
                            <h1 class="text-3xl md:text-4xl font-black">${title}</h1>
                        </div>
                    </div>

                    <!-- Player selector button -->
                    <div class="mb-4 flex items-center gap-3">
                        <span class="text-gray-400 text-sm">–ü–ª–µ–µ—Ä:</span>
                        <button id="player-selector-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-bold text-sm transition flex items-center gap-2">
                            <span id="current-player-name">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                            <span class="material-icons text-sm">expand_more</span>
                        </button>
                    </div>

                    <!-- Player container -->
                    <div id="player-wrapper" class="player-aspect bg-[#0a0a0a] rounded-2xl overflow-hidden shadow-2xl border border-gray-800 relative ${user?.settings?.player_center ? 'centered' : ''}">
                        <div id="player-container" class="w-full h-full"></div>
                    </div>

                    <!-- Control buttons -->
                    <div id="player-controls" class="mt-4 flex items-center gap-3 flex-wrap">
                        <div class="relative">
                            <button id="btn-center" class="control-btn" title="–û—Ç—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–µ–µ—Ä">
                                <span class="material-icons">center_focus_strong</span>
                                <span class="tooltip">–û—Ç—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</span>
                            </button>
                        </div>
                        <div class="relative">
                            <button id="btn-theater" class="control-btn" title="–¢–µ–∞—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º">
                                <span class="material-icons">aspect_ratio</span>
                                <span class="tooltip">–¢–µ–∞—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º</span>
                            </button>
                        </div>
                        <div class="relative">
                            <button id="btn-fullscreen" class="control-btn" title="–ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω">
                                <span class="material-icons">fullscreen</span>
                                <span class="tooltip">–ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω</span>
                            </button>
                        </div>
                        <div class="relative">
                            <button id="btn-copy-link" class="control-btn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">
                                <span class="material-icons">content_copy</span>
                                <span class="tooltip">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</span>
                            </button>
                        </div>
                    </div>

                    <!-- Player modal -->
                    <div id="player-modal" class="player-modal hidden">
                        <div class="player-modal-content">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold">–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–µ–µ—Ä</h2>
                                <button id="close-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                            </div>
                            <div id="player-list"></div>
                        </div>
                    </div>
                `;
                app.appendChild(main);

                // --- Comments & Ratings Integration ---
                const userObj = JSON.parse(localStorage.getItem('user') || 'null');
                const currentRating = userObj?.ratings?.[`${type}_${id}`] || null;

                const socialSection = document.createElement('div');
                socialSection.className = 'mt-12';
                socialSection.innerHTML = `
                    ${renderRatingBar(id, type, currentRating)}
                    ${renderCommentsSection(id, type, userObj)}
                `;
                main.appendChild(socialSection);

                initCommentsLogic(id, type);
                // ----------------------------------------

                // Initialize Player
                const playerContainer = document.getElementById('player-container');
                const playerSelectorBtn = document.getElementById('player-selector-btn');
                const currentPlayerName = document.getElementById('current-player-name');
                const playerModal = document.getElementById('player-modal');
                const playerList = document.getElementById('player-list');
                const closeModal = document.getElementById('close-modal');

                // Show loading state
                playerContainer.innerHTML = `
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                        <svg class="w-10 h-10 animate-spin text-red-600 mb-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–µ–µ—Ä–æ–≤ —Å —Ä—É—Å—Å–∫–æ–π –æ–∑–≤—É—á–∫–æ–π...</p>
                    </div>
                `;

                try {
                    const apiUrl = `/api/players?id=${id}&type=${type}`;

                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error('API request failed');

                    const result = await response.json();
                    players = result.data?.filter(p => p?.iframeUrl && p?.type) || [];

                    if (players.length === 0) {
                        playerContainer.innerHTML = `
                            <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                                <span class="material-icons text-6xl text-gray-700 mb-4">sentiment_dissatisfied</span>
                                <p class="text-gray-400">–ü–ª–µ–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                                <p class="text-gray-600 text-sm mt-1">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
                            </div>
                        `;
                        currentPlayerName.textContent = '–ù–µ—Ç –ø–ª–µ–µ—Ä–æ–≤';
                    } else {
                        // Restore preferred player
                        const preferredPlayer = localStorage.getItem('preferred_player');
                        selectedPlayerIndex = players.findIndex(p => p.type === preferredPlayer);
                        if (selectedPlayerIndex === -1) selectedPlayerIndex = 0;

                        loadPlayer(selectedPlayerIndex);
                        updatePlayerList();
                    }
                } catch (err) {
                    console.error('Player loading error:', err);
                    playerContainer.innerHTML = `
                        <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                            <span class="material-icons text-6xl text-red-600 mb-4">error_outline</span>
                            <p class="text-gray-400">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–µ–µ—Ä–æ–≤</p>
                            <p class="text-gray-600 text-sm mt-1">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
                        </div>
                    `;
                    currentPlayerName.textContent = '–û—à–∏–±–∫–∞';
                }


                // Listen for messages from players (postMessage)
                window.addEventListener('message', async (event) => {
                    // Try to parse player messages for progress
                    // Common player event formats:
                    try {
                        const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;

                        // Alloha / Reyohoho / VidSrc often use these keys
                        if (data.event === 'timeupdate' || data.event === 'progress' || data.type === 'progress') {
                            const time = data.time || data.seconds || data.position;
                            const duration = data.duration || data.total;

                            if (time) currentProgress.time = time;
                            if (duration) currentProgress.duration = duration;

                            // Sync every 20 seconds
                            if (Date.now() - lastProgressSync > 20000) {
                                syncProgress();
                            }
                        }

                        // Episode changes
                        if (data.event === 'episode_changed' || data.event === 'change_episode') {
                            currentProgress.season = data.season || currentProgress.season;
                            currentProgress.episode = data.episode || currentProgress.episode;
                            currentProgress.time = 0;
                            syncProgress();
                        }
                    } catch (e) {
                        // Not a JSON message or not from a player we recognize
                    }
                });

                async function syncProgress() {
                    const token = localStorage.getItem('token');
                    if (!token) return;

                    try {
                        const { updateWatchProgress } = await import('./js/api.js');
                        await updateWatchProgress(id, type, {
                            time: Math.floor(currentProgress.time),
                            duration: Math.floor(currentProgress.duration),
                            season: currentProgress.season,
                            episode: currentProgress.episode
                        });
                        lastProgressSync = Date.now();
                    } catch (err) {
                        console.error('Failed to sync progress:', err);
                    }
                }

                // Initial sync shortly after load
                setTimeout(syncProgress, 5000);
                // Save progress on leave
                window.addEventListener('beforeunload', syncProgress);

                function updatePlayerList() {
                    playerList.innerHTML = '';
                    players.forEach((player, index) => {
                        const btn = document.createElement('button');
                        btn.className = `player-list-item ${index === selectedPlayerIndex ? 'active' : ''}`;
                        btn.innerHTML = `
                            <div class="flex items-center justify-between">
                                <span class="font-bold">${player.type}</span>
                                <span class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300">
                                    ${player.lang === 'ru' ? 'üá∑üá∫ RU' : player.lang === 'en' ? 'üá∫üá∏ ENG' : 'üåç Multi'}
                                </span>
                            </div>
                            <div class="text-xs text-gray-400 mt-1">${player.name || player.type} - ${player.quality || 'HD'}</div>
                        `;
                        btn.addEventListener('click', () => {
                            loadPlayer(index);
                            updatePlayerList();
                            playerModal.classList.add('hidden');
                        });
                        playerList.appendChild(btn);
                    });
                }

                // Event listeners
                playerSelectorBtn.addEventListener('click', () => {
                    playerModal.classList.remove('hidden');
                });

                closeModal.addEventListener('click', () => {
                    playerModal.classList.add('hidden');
                });

                playerModal.addEventListener('click', (e) => {
                    if (e.target === playerModal) {
                        playerModal.classList.add('hidden');
                    }
                });

                // Control buttons
                document.getElementById('btn-center').addEventListener('click', () => {
                    document.getElementById('player-wrapper').scrollIntoView({ behavior: 'smooth', block: 'center' });
                });

                document.getElementById('btn-theater').addEventListener('click', () => {
                    const wrapper = document.getElementById('player-wrapper');
                    const btn = document.getElementById('btn-theater');
                    theaterMode = !theaterMode;

                    if (theaterMode) {
                        wrapper.style.position = 'fixed';
                        wrapper.style.inset = '0';
                        wrapper.style.zIndex = '50';
                        wrapper.style.borderRadius = '0';
                        wrapper.style.maxWidth = '100%';
                        btn.classList.add('active');
                    } else {
                        wrapper.style.position = '';
                        wrapper.style.inset = '';
                        wrapper.style.zIndex = '';
                        wrapper.style.borderRadius = '';
                        wrapper.style.maxWidth = '';
                        btn.classList.remove('active');
                    }
                });

                document.getElementById('btn-fullscreen').addEventListener('click', () => {
                    const iframe = playerContainer.querySelector('iframe');
                    if (iframe && iframe.requestFullscreen) {
                        iframe.requestFullscreen();
                    }
                });

                document.getElementById('btn-copy-link').addEventListener('click', () => {
                    navigator.clipboard.writeText(window.location.href);
                    const btn = document.getElementById('btn-copy-link');
                    btn.classList.add('active');
                    setTimeout(() => btn.classList.remove('active'), 1500);
                });

                // Escape key closes theater mode and modal
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (!playerModal.classList.contains('hidden')) {
                            playerModal.classList.add('hidden');
                        } else if (theaterMode) {
                            document.getElementById('btn-theater').click();
                        }
                    }
                });

                app.insertAdjacentHTML('beforeend', renderFooter());

            } catch (error) {
                console.error('Watch error:', error);
                app.insertAdjacentHTML('beforeend', '<p class="text-center pt-32">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</p>');
            }
        }

        initWatchPage();
    </script>
</body>

</html>