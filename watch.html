<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Просмотр - Онлайн Кинотеатр</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/custom.css">
    <style>
        .player-aspect {
            aspect-ratio: 16 / 9;
        }
    </style>
</head>

<body class="bg-black text-white min-h-screen">
    <div id="app"></div>

    <script type="module">
        import { renderHeader, renderFooter } from './js/components.js';
        import { getMovieDetails, getTVSeriesDetails, updateWatchProgress, addToHistory } from './js/api.js';
        import { initMobileMenu, updateAuthLinks, initSearch } from './js/utils.js';

        const app = document.getElementById('app');

        async function initWatchPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            const type = urlParams.get('type') || 'movie';

            if (!id) {
                window.location.href = 'index.html';
                return;
            }

            app.innerHTML = renderHeader();
            initMobileMenu();
            updateAuthLinks();
            initSearch();

            try {
                const item = type === 'movie' ? await getMovieDetails(id) : await getTVSeriesDetails(id);
                const title = item.title || item.name;

                // Add to history
                const user = JSON.parse(localStorage.getItem('user'));
                if (user && localStorage.getItem('token')) {
                    addToHistory(item, type).catch(err => console.error('History update failed:', err));
                }

                const currentProgress = user?.progress?.[`${type}_${id}`] || { season: 1, episode: 1 };

                const main = document.createElement('main');
                main.className = 'pt-24 pb-12 max-w-6xl mx-auto px-4';
                main.innerHTML = `
                    <div class="mb-6 flex flex-col md:flex-row md:items-end justify-between gap-4">
                        <div>
                            <nav class="flex text-gray-500 text-sm mb-2" aria-label="Breadcrumb">
                                <ol class="list-none p-0 inline-flex">
                                    <li class="flex items-center">
                                        <a href="index.html" class="hover:text-red-600 transition">Главная</a>
                                        <svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
                                    </li>
                                    <li class="flex items-center">
                                        <a href="details.html?id=${id}&type=${type}" class="hover:text-red-600 transition">${title}</a>
                                        <svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
                                    </li>
                                    <li class="text-white font-bold">Просмотр</li>
                                </ol>
                            </nav>
                            <h1 class="text-3xl md:text-4xl font-black">${title}</h1>
                        </div>
                        
                        ${type === 'tv' ? `
                            <div class="flex items-center gap-4 bg-gray-900 p-3 rounded-xl border border-gray-800">
                                <div class="flex flex-col">
                                    <label class="text-[10px] text-gray-500 uppercase font-bold">Сезон</label>
                                    <input type="number" id="season-input" value="${currentProgress.season}" min="1" class="bg-transparent text-white font-bold w-12 focus:outline-none">
                                </div>
                                <div class="w-px h-8 bg-gray-800"></div>
                                <div class="flex flex-col">
                                    <label class="text-[10px] text-gray-500 uppercase font-bold">Серия</label>
                                    <input type="number" id="episode-input" value="${currentProgress.episode}" min="1" class="bg-transparent text-white font-bold w-12 focus:outline-none">
                                </div>
                                <button id="save-progress" class="ml-2 p-2 bg-red-600 rounded-lg hover:bg-red-700 transition">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                </button>
                            </div>
                        ` : ''}
                    </div>

                    <div class="player-aspect bg-[#0a0a0a] rounded-2xl overflow-hidden shadow-2xl border border-gray-800 flex flex-col items-center justify-center relative group">
                        <!-- Placeholder Player UI -->
                        <div class="absolute inset-0 bg-cover bg-center opacity-20" style="background-image: url('https://image.tmdb.org/t/p/original${item.backdrop_path}')"></div>
                        
                        <div class="z-10 text-center px-4">
                            <div class="w-20 h-20 bg-red-600 rounded-full flex items-center justify-center mx-auto mb-6 cursor-pointer hover:scale-110 transition duration-300 shadow-lg shadow-red-900/50">
                                <svg class="w-10 h-10 text-white ml-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M4.5 3.5v13l11-6.5-11-6.5z"></path>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold mb-2">Плеер находится в разработке</h2>
                            <p class="text-gray-400 max-w-md mx-auto">В финальной версии здесь будет располагаться видеоплеер с возможностью выбора озвучки и качества.</p>
                        </div>

                        <!-- Progress Bar Mockup -->
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gray-800">
                            <div class="h-full bg-red-600 w-1/3"></div>
                        </div>
                    </div>

                    <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-gray-900 bg-opacity-50 p-6 rounded-xl border border-gray-800">
                            <h3 class="font-bold text-xl mb-3 border-b border-red-600 pb-1 w-fit">Полезная информация</h3>
                            <ul class="space-y-2 text-gray-400 italic">
                                <li>• Пользуйтесь наушниками для лучшего качества звука</li>
                                <li>• Если плеер не загружается, попробуйте сменить сервер</li>
                                <li>• Приятного просмотра!</li>
                            </ul>
                        </div>
                        <div class="bg-gray-900 bg-opacity-50 p-6 rounded-xl border border-gray-800 flex items-center justify-center">
                            <div class="text-center">
                                <p class="text-3xl font-bold text-red-600 mb-1">1080p</p>
                                <p class="text-xs text-gray-500 uppercase tracking-widest">Максимальное качество</p>
                            </div>
                        </div>
                    </div>
                `;
                app.appendChild(main);

                // Progress saving logic
                if (type === 'tv') {
                    const saveBtn = document.getElementById('save-progress');
                    saveBtn.addEventListener('click', async () => {
                        const season = parseInt(document.getElementById('season-input').value);
                        const episode = parseInt(document.getElementById('episode-input').value);

                        try {
                            const originalContent = saveBtn.innerHTML;
                            saveBtn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
                            await updateWatchProgress(id, type, { season, episode });
                            saveBtn.innerHTML = '<svg class="w-5 h-5 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                            setTimeout(() => { saveBtn.innerHTML = originalContent; }, 2000);
                        } catch (err) {
                            console.error('Failed to save progress:', err);
                        }
                    });
                }

                app.insertAdjacentHTML('beforeend', renderFooter());

            } catch (error) {
                console.error('Watch error:', error);
                app.insertAdjacentHTML('beforeend', '<p class="text-center pt-32">Ошибка при загрузке плеера</p>');
            }
        }

        initWatchPage();
    </script>
</body>

</html>